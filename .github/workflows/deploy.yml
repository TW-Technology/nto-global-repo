name: Infra Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Infra Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout files repository
        uses: actions/checkout@v2

      - name: Configurar credenciais do Git
        run: |
          git config --global user.email "robertoasgon@gmail.com"
          git config --global user.name "RobertoAssis"
          git config --global credential.helper "store --file ~/.git-credentials"

      - name: Armazenar credenciais do Git
        run: echo "https://${{ secrets.PAT_TOKEN }}:x-oauth-basic@github.com" > ~/.git-credentials

      - name: Atualizar submÃ³dulos
        run: |
          git submodule update --init --recursive
          cd /home/nto-global-repo/nto-web-api
          git config --local credential.helper "store --file ~/.git-credentials"
          git fetch origin
          git checkout origin/main

      - name: Set up SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}

      - name: Update files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          source: ./
          target: /home/nto-global-repo/

      - name: Check if Docker is installed
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          script: |
            if ! command -v docker &> /dev/null; then
              echo "Docker is not installed"
              INSTALL_DOCKER=true
            else
              echo "Docker is already installed"
              INSTALL_DOCKER=false
            fi

      - name: Install Docker
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          if: ${{ steps.check-docker.outputs.INSTALL_DOCKER == 'true' }}
          script: |
            sudo apt-get update
            sudo apt-get install -y docker.io
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            docker-compose version

      - name: Build and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          script: |
            cd /home/nto-global-repo/
            docker-compose stop
            docker-compose build
            docker-compose up
